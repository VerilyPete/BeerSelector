appId: org.verily.FSbeerselector
name: "Data Refresh - Pull-to-Refresh and Manual Refresh"
---
# Test Flow: Data Refresh Functionality
# This test verifies pull-to-refresh gestures, loading indicators,
# data updates, and duplicate request prevention across all tabs.
#
# Prerequisites:
# - App should be logged in (not visitor mode)
# - API URLs configured
# - Some beer data already loaded

# Step 1: Launch app with existing state
- launchApp:
    clearState: false

# Step 2: Wait for app initialization
- waitForAnimationToEnd:
    timeout: 5000

# ========================================
# Test 1: Refresh on All Beer Tab
# ========================================

# Step 3: Navigate to All Beer tab
- tapOn: "All Beer"
- waitForAnimationToEnd

# Step 4: Verify initial beer list is visible
- assertVisible:
    id: "all-beers-container"
- assertVisible:
    id: "beer-list"

# Step 5: Store initial beer count for comparison
- runScript:
    env:
      INITIAL_ALL_BEER_COUNT: ${output.text}
    script: |
      output.text = await maestro.getText({id: 'beer-count'})

# Step 6: Perform pull-to-refresh gesture
# Start from middle of beer list and swipe down
- swipe:
    direction: DOWN
    from:
      id: "beer-list"
    duration: 800

# Step 7: Wait for refresh to complete
# API call may take up to 15 seconds (timeout from dataUpdateService)
- waitForAnimationToEnd:
    timeout: 20000

# Step 8: Verify list is still visible after refresh
- assertVisible:
    id: "beer-list"

# Step 9: Verify beer count is displayed (may have changed)
- assertVisible:
    id: "beer-count"

# Step 10: Scroll down to verify list data rendered
- scroll:
    direction: DOWN
- waitForAnimationToEnd

# ========================================
# Test 2: Refresh on Beerfinder Tab
# ========================================

# Step 11: Navigate to Beerfinder tab (untasted beers)
- tapOn: "Beerfinder"
- waitForAnimationToEnd:
    timeout: 3000

# Step 12: Verify beerfinder list is visible
- assertVisible:
    id: "beer-list"

# Step 13: Store initial untasted beer count
- runScript:
    env:
      INITIAL_BEERFINDER_COUNT: ${output.text}
    script: |
      output.text = await maestro.getText({id: 'beer-count'})

# Step 14: Perform pull-to-refresh on beerfinder
- swipe:
    direction: DOWN
    from:
      id: "beer-list"
    duration: 800

# Step 15: Wait for refresh to complete
- waitForAnimationToEnd:
    timeout: 20000

# Step 16: Verify list is still visible
- assertVisible:
    id: "beer-list"

# Step 17: Verify beer count is displayed
- assertVisible:
    id: "beer-count"

# ========================================
# Test 3: Refresh on Tasted Brews Tab
# ========================================

# Step 18: Navigate to Tasted Brews tab
- tapOn: "Tasted Brews"
- waitForAnimationToEnd:
    timeout: 3000

# Step 19: Verify tasted brews list or empty state
# If user has no tasted beers, we'll see empty state
# If user has tasted beers, we'll see the list
- assertVisible:
    text: "tasted|available|No beers"
    # Matches either "X brews tasted" or empty state message

# Step 20: Attempt pull-to-refresh on tasted brews
# This should work regardless of empty state or populated list
- swipe:
    direction: DOWN
    duration: 800

# Step 21: Wait for refresh to complete
- waitForAnimationToEnd:
    timeout: 20000

# Step 22: Verify screen is still responsive
- assertVisible:
    id: "search-bar"

# ========================================
# Test 4: Rapid Refresh Prevention
# ========================================

# Step 23: Go back to All Beer tab for duplicate prevention test
- tapOn: "All Beer"
- waitForAnimationToEnd

# Step 24: Perform first refresh
- swipe:
    direction: DOWN
    from:
      id: "beer-list"
    duration: 800

# Step 25: Immediately attempt second refresh (should be ignored)
# The refresh hook prevents duplicate requests
- swipe:
    direction: DOWN
    from:
      id: "beer-list"
    duration: 800

# Step 26: Wait for first refresh to complete
# Only one refresh should occur
- waitForAnimationToEnd:
    timeout: 20000

# Step 27: Verify app is still responsive
- assertVisible:
    id: "beer-list"
- assertVisible:
    id: "beer-count"

# ========================================
# Test 5: Manual Refresh from Settings
# ========================================

# Step 28: Navigate to Settings via Home tab
- tapOn: "Home"
- waitForAnimationToEnd

# Step 29: Scroll down to find Settings button (if needed)
- scroll:
    direction: DOWN

# Step 30: Tap Settings button
- tapOn: "Settings"
- waitForAnimationToEnd:
    timeout: 3000

# Step 31: Verify we're on settings screen
- assertVisible:
    text: "Settings"

# Step 32: Scroll to find Data Management section
- scroll:
    direction: DOWN

# Step 33: Verify "Refresh All Beer Data" button exists
- assertVisible:
    text: "Refresh All Beer Data"

# Step 34: Tap refresh button
- tapOn:
    text: "Refresh All Beer Data"

# Step 35: Verify loading state appears
# Button text should change to "Refreshing data..."
- assertVisible:
    text: "Refreshing data..."

# Step 36: Wait for refresh to complete
- waitForAnimationToEnd:
    timeout: 20000

# Step 37: Verify button returns to normal state
- assertVisible:
    text: "Refresh All Beer Data"

# Step 38: Navigate back to beer list to verify data updated
- tapOn: "All Beer"
- waitForAnimationToEnd

# Step 39: Verify beer list is still functioning
- assertVisible:
    id: "beer-list"
- assertVisible:
    id: "beer-count"

# ========================================
# Test 6: Refresh with Network Simulation
# (Note: Actual network conditions testing would require
# additional Maestro features or device-level settings)
# ========================================

# Step 40: Perform one final refresh to ensure stability
- swipe:
    direction: DOWN
    from:
      id: "beer-list"
    duration: 800

# Step 41: Wait for completion
- waitForAnimationToEnd:
    timeout: 20000

# Step 42: Verify app recovered and data is visible
- assertVisible:
    id: "beer-list"
- assertVisible:
    id: "beer-count"

# Test Complete
# ==============
# This test verifies:
# ✓ Pull-to-refresh works on All Beer, Beerfinder, and Tasted Brews tabs
# ✓ Loading indicators appear during refresh
# ✓ Data updates after refresh
# ✓ Duplicate refresh requests are prevented
# ✓ Manual refresh from Settings screen works
# ✓ App remains responsive throughout refresh operations
# ✓ Refresh handles both populated and empty states
