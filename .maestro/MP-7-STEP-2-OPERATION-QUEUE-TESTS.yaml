# MP-7 Step 2: Operation Queue E2E Tests
#
# Tests the operation queue system for offline support:
# - Queuing operations when offline
# - Auto-retry when connection restored
# - Manual retry of failed operations
# - Viewing and managing queued operations
#
# Prerequisites:
# - App must be logged in (run login flow first)
# - Test device must support network simulation
#
# Run with:
#   maestro test .maestro/MP-7-STEP-2-OPERATION-QUEUE-TESTS.yaml

appId: org.verily.FSbeerselector
---

# ==============================================================================
# TEST 1: Queue Operation When Offline
# ==============================================================================
- runFlow:
    file: ./login-flow.yaml
    when:
      visible: "Settings"

- tapOn: "Beerfinder"
- assertVisible: "Beerfinder"

# Simulate going offline
- setAirplaneMode: true
- waitForAnimationToEnd

# Try to check in a beer
- tapOn:
    text: ".*IPA.*"
    index: 0
- tapOn: "Check In"

# Should show queued message
- assertVisible:
    text: "Queued for Later"

- tapOn: "OK"

# Verify queued operations indicator appears
- assertVisible:
    text: "Queued Operations"

# ==============================================================================
# TEST 2: View Queued Operations
# ==============================================================================
- tapOn: "Queued Operations"
- assertVisible: "Queued Operations"

# Should show the queued beer check-in
- assertVisible:
    text: "Check-in Beer"

- assertVisible:
    text: "Pending"

# Close the modal
- tapOn: "✕"

# ==============================================================================
# TEST 3: Auto-Retry When Connection Restored
# ==============================================================================
# Go back online
- setAirplaneMode: false
- waitForAnimationToEnd

# Wait for auto-retry (2 second debounce + execution time)
- wait: 5000

# Queued operations indicator should disappear or show success
# Note: This depends on whether the check-in succeeds
# For now, we just verify the retry happened by checking the indicator

# ==============================================================================
# TEST 4: Manual Retry of Operation
# ==============================================================================
# Go offline again
- setAirplaneMode: true
- waitForAnimationToEnd

# Queue another operation
- tapOn: "Beerfinder"
- tapOn:
    text: ".*Stout.*"
    index: 0
- tapOn: "Check In"
- assertVisible: "Queued for Later"
- tapOn: "OK"

# Open queued operations modal
- tapOn: "Queued Operations"
- assertVisible: "Queued Operations"

# Manually retry (will fail because still offline)
- tapOn:
    text: "Retry"
    index: 0

- wait: 2000

# Should still show as pending or failed
- assertVisible:
    text: ".*Pending.*|.*Failed.*"

# Close modal
- tapOn: "✕"

# ==============================================================================
# TEST 5: Delete Queued Operation
# ==============================================================================
- tapOn: "Queued Operations"
- assertVisible: "Queued Operations"

# Delete one operation
- tapOn:
    text: "Delete"
    index: 0

# Should remove from list
- wait: 1000

# ==============================================================================
# TEST 6: Clear All Queued Operations
# ==============================================================================
# Open modal again
- tapOn: "Queued Operations"
- assertVisible: "Queued Operations"

# Clear all operations
- tapOn: "Clear All"
- assertVisible: "Are you sure"
- tapOn: "Clear All"

# Modal should close
- wait: 1000

# Indicator should disappear
- assertNotVisible:
    text: "Queued Operations"

# ==============================================================================
# CLEANUP: Restore Network
# ==============================================================================
- setAirplaneMode: false
- waitForAnimationToEnd
