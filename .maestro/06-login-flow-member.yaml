appId: org.verily.FSbeerselector
name: "Login Flow - UFO Club Member Authentication"
---
# Test Flow: UFO Club Member Login
# This test verifies the complete login flow for a UFO Club member:
# 1. First launch detection and redirect to settings
# 2. Login button interaction
# 3. WebView login process
# 4. Session persistence
# 5. Data refresh after login
# 6. Logout functionality

# ======================
# STEP 1: First Launch
# ======================

# Launch app with cleared state to simulate first install
- launchApp:
    clearState: true

# Wait for app initialization (database setup)
- waitForAnimationToEnd

# Dismiss Expo dev menu if present
- runFlow:
    when:
      visible: "Reload"
    commands:
      - pressKey: Escape
      - waitForAnimationToEnd

# Verify we're redirected to settings screen (first launch behavior)
- assertVisible:
    text: "Settings"

# Verify welcome message is shown for first-time users
- assertVisible:
    text: "Welcome to Beer Selector"

# Verify instructional text
- assertVisible:
    text: "Please log in to your UFO Club account or as a Visitor to start using the app."

# ======================
# STEP 2: Initiate Login
# ======================

# Verify login button exists and is accessible
- assertVisible:
    text: "Login to Flying Saucer"

# Tap the login button to open WebView
- tapOn:
    text: "Login to Flying Saucer"
- waitForAnimationToEnd

# Verify WebView modal opens
- assertVisible:
    id: "login-webview-modal"

# Verify WebView header is shown
- assertVisible:
    text: "Flying Saucer Login"

# Verify close button exists (user can cancel)
- assertVisible:
    id: "close-webview-button"

# Wait for WebView to load the login page (kiosk.php)
# This may take several seconds depending on network
- waitForAnimationToEnd

# ======================
# STEP 3: WebView Login Process
# ======================

# Note: The actual login form interaction depends on the Flying Saucer website
# In a real test environment, you would:
# 1. Wait for the login form to load
# 2. Enter credentials (test account)
# 3. Submit the form
# 4. Wait for redirect to member dashboard

# For now, we'll verify the WebView loaded successfully
# and the user can interact with it

# Verify the WebView is still visible (didn't crash)
- assertVisible:
    id: "login-webview-modal"

# In a real test with valid credentials, the WebView would:
# - Navigate to member-dash.php after successful login
# - JavaScript injection would extract session cookies and API URLs
# - App would save session data and close the WebView
# - Alert would show "Login Successful"

# ======================
# STEP 4: Test Login Cancellation
# ======================

# Test that user can cancel login process
- tapOn:
    id: "close-webview-button"
- waitForAnimationToEnd

# Verify we're back on settings screen
- assertVisible:
    text: "Settings"

# Verify WebView is dismissed
- assertNotVisible:
    id: "login-webview-modal"

# ======================
# STEP 5: Retry Login (Success Path)
# ======================

# Tap login button again
- tapOn:
    text: "Login to Flying Saucer"
- waitForAnimationToEnd

# Verify WebView opens again
- assertVisible:
    id: "login-webview-modal"

# Wait for page to load
- waitForAnimationToEnd

# NOTE: In a real E2E test with a test account, you would:
# 1. Locate username/password fields in WebView
# 2. Enter test credentials
# 3. Submit form
# 4. Wait for success alert: "Login Successful"
# 5. Tap "OK" on alert
# 6. Verify navigation to home screen

# For manual testing or with test credentials, the flow would be:
# - User logs in via WebView
# - Session cookies are extracted and saved
# - API URLs are configured automatically
# - Data is refreshed (all beers, tasted beers, rewards)
# - User is redirected to home screen or beer list

# ======================
# STEP 6: Post-Login Verification
# ======================

# Post-login verification requires valid UFO Club test account credentials.
# These assertions are disabled because automated CI testing doesn't have access
# to test credentials and cannot complete the login flow.
#
# Manual Test Checklist (after successful member login):
# 1. [ ] Verify "Login Successful" alert appears (within 30s)
# 2. [ ] Tap "OK" on alert and verify navigation
# 3. [ ] Verify redirect to All Beer tab
# 4. [ ] Verify beer list container is visible (testID: "all-beers-container")
# 5. [ ] Verify beer list loads with data (testID: "beer-list")
# 6. [ ] Verify beer count displays non-zero value (testID: "beer-count")
# 7. [ ] Navigate to Settings screen
# 8. [ ] Verify "Data Management" section appears (logged-in state)
# 9. [ ] Verify "Refresh All Beer Data" button is enabled
# 10. [ ] Verify user session persists after app restart
#
# To run automated tests with credentials:
# 1. Create .env.test with TEST_UFO_EMAIL and TEST_UFO_PASSWORD
# 2. Create dedicated test file: .maestro/06a-login-flow-member-success.yaml
# 3. Implement WebView form interaction (input username/password fields)
# 4. Add post-login assertions for data verification
#
# Tracking:
# TODO - Create 06a-login-flow-member-success.yaml for credential-based E2E testing
# TODO - Set up secure test credentials in CI environment
# TODO - Implement WebView form interaction helpers for login automation

# ======================
# Test Complete
# ======================

# This test verifies:
# ✓ First launch detection
# ✓ Redirect to settings screen
# ✓ Login button accessibility
# ✓ WebView modal opens
# ✓ WebView can be dismissed
# ✓ Login cancellation works
# ✓ Login flow can be retried

# To fully test successful login:
# - Set up test Flying Saucer account credentials
# - Configure WebView form interaction (username/password input)
# - Add post-login assertions
# - Test data refresh and navigation
